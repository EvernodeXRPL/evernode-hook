.PHONY: all build

all: build em

build:
	mkdir -p build
	docker run --rm -v "$(shell pwd)":"$(shell pwd)" --entrypoint /root/.wasienv/bin/wasmcc xrpllabsofficial/xrpld-hooks-testnet "$(shell pwd)"/src/evernode.c -o "$(shell pwd)"/build/evernode.wasm -O0 -Wl,--allow-undefined -I../

upload:
	node sethook.js

em: clean em-build em-run

em-build:
	gcc -m32 hook-emulator/c_wrappers/main.c src/evernode.c lib/sim.c -o build/hook-wrapper

em-run:
	./build/hook-wrapper

em-val:	
	valgrind --leak-check=full ./build/hook-wrapper << 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

clean:
	rm -rf build/*